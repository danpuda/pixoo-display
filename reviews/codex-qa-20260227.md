# Pixoo Display 全Phase コードレビュー（QA / Codex）

## スコア
**73/100**

- 総評: 機能実装はかなり進んでおり、`tmux -> JSON` の原子的書き込みや描画キャッシュなど良い設計が入っています。一方で、運用時の耐障害性（Pixooオフライン時）と共有状態ファイルの責務分離に致命的な問題があります。

## 🔴 致命的

- **Pixooオフライン/通信失敗で表示プロセスが即終了する**
  - 根拠: 送信処理 `pixoo.draw_image()` / `pixoo.push()` がループ内で直接呼ばれており、ここを保護する `except` がありません（`pixoo-display-test.py:744`, `pixoo-display-test.py:745`）。
  - `run()` の末尾は `KeyboardInterrupt` しか捕捉していないため、ネットワーク例外・タイムアウト系が発生すると常駐表示が停止します（`pixoo-display-test.py:752`）。
  - 影響: ユーザー指定の「Pixooオフライン時」の要件未達。復旧も自動再接続されません。

- **表示側が共有JSONを書き戻しており、syncデーモンと競合して状態を壊す/巻き戻す可能性がある**
  - 根拠: `read_agent_state()` は本来 reader ですが、TTL期限切れ検出時に `STATE_FILE.write_text(...)` で共有ファイルを書き換えています（`pixoo-display-test.py:190`, `pixoo-display-test.py:206`, `pixoo-display-test.py:207`）。
  - `pixoo_tmux_sync.py` 側は `tempfile + os.replace` で原子的に書いているのに（`pixoo_tmux_sync.py:336`, `pixoo_tmux_sync.py:347`, `pixoo_tmux_sync.py:357`）、表示側の `write_text()` は非原子的で、競合時に部分書き込み/古い内容の上書きのリスクがあります。
  - 影響: 一時的な JSON 破損、エージェント状態の巻き戻り、表示のチラつき/誤表示。責務分離（writerはsyncのみ）が崩れています。

## 🟡 改善

- **Gitコミットスキャンが描画ループを同期ブロックし、最悪数十秒フリーズし得る**
  - 根拠: `get_latest_git_commits()` をメインループ内で直接実行（`pixoo-display-test.py:609`, `pixoo-display-test.py:610`）。
  - 各repoに `git log -1` を順次実行し、各5秒タイムアウト（`pixoo-display-test.py:303`, `pixoo-display-test.py:307`, `pixoo-display-test.py:310`）。12 repo あるため、マウント不調時などに理論上 ~60秒ブロック。
  - 影響: フレーム更新/スクロール更新が止まり、Pixoo送信も止まる。体感品質が大きく劣化。

- **`read_agent_state()` の入力バリデーション不足で、JSON形式は正しいが形が崩れているとクラッシュし得る**
  - 根拠: `json.loads()` の結果を dict 前提で `.get()` している（`pixoo-display-test.py:195`, `pixoo-display-test.py:196`）。
  - `except` が `json.JSONDecodeError, OSError` のみで、`AttributeError` / `TypeError` を拾っていません（`pixoo-display-test.py:211`）。
  - 例: 一時的に `[]` や `"..."` が書かれた場合、または `agents` 内要素が dict でない場合に常駐表示プロセスが落ちる可能性。

- **tmux window名の重複で `id` / `started` 追跡が衝突する**
  - 根拠: `first_seen` を window名キーで保持（`pixoo_tmux_sync.py:310`, `pixoo_tmux_sync.py:311`）、JSONの `id` も window名（`pixoo_tmux_sync.py:316`）。
  - `tmux` は同名windowを作れるため、重複時に開始時刻が混ざる・表示ログ差分判定が不正確になる可能性があります（`pixoo_tmux_sync.py:329`, `pixoo_tmux_sync.py:420`）。
  - 備考: PL選定では `window_index` を使う修正が入っており、この問題だけ未解消状態です。

- **`capture-pane` のターゲットが pane固定ではなく、複数pane windowで取得内容が不安定**
  - 根拠: `tmux capture-pane -t shared:<window_index>` で pane index を指定していない（`pixoo_tmux_sync.py:75`, `pixoo_tmux_sync.py:76`）。
  - 影響: split pane 運用時に「どのpaneのログを拾うか」がアクティブpane依存になり、`status` 判定や `scroll_text` が揺れる可能性。

- **未使用コード/設定が残っており、実装意図の追跡コストが上がる**
  - `TODO_POLL_SEC` と `get_top_priority_task()` が現行フローで未使用（`pixoo-display-test.py:77`, `pixoo-display-test.py:270`）。
  - `compose_frame()` の `ui_font` 引数が未使用（`pixoo-display-test.py:404`）。呼び出し側で生成/受け渡しだけしている（`pixoo-display-test.py:514`, `pixoo-display-test.py:734`）。

- **`load_frames()` で `Image.open()` をコンテキスト管理しておらず、起動時のFD解放タイミングがGC依存**
  - 根拠: `Image.open(path).convert("RGB")` を直接使用（`pixoo-display-test.py:183`）。
  - 影響: 常時リークにはなりにくいが、起動時に多数画像を読む構成ではFD管理の明示性が低い。

## 🟢 良い点

- **コマンドインジェクション耐性が良い**
  - `subprocess.run()` は全て引数配列で実行しており `shell=True` を使っていない（`pixoo_tmux_sync.py:74`, `pixoo_tmux_sync.py:221`, `pixoo-display-test.py:307`）。

- **tmux sync側の状態ファイル書き込みが原子的**
  - `tempfile.mkstemp()` + `os.replace()` により、表示側が半端なJSONを読み込むリスクを下げています（`pixoo_tmux_sync.py:347`, `pixoo_tmux_sync.py:357`）。

- **tmux未起動/未接続時のフォールバックがある**
  - `get_tmux_windows()` が `None` を返し、空状態を書いて表示側へ明示的に伝える設計は妥当です（`pixoo_tmux_sync.py:213`, `pixoo_tmux_sync.py:387`, `pixoo_tmux_sync.py:417`）。

- **描画パフォーマンスに対する配慮が入っている**
  - `ScrollTextCache` による文字列ストリップ再利用で `Pilmoji` の毎フレーム再描画を避けている（`pixoo-display-test.py:352`, `pixoo-display-test.py:361`, `pixoo-display-test.py:492`）。

- **外部コマンドにタイムアウトが設定されている**
  - `tmux` / `git` 呼び出しに `timeout=5` があり、ハング耐性の基本は押さえています（`pixoo_tmux_sync.py:79`, `pixoo_tmux_sync.py:228`, `pixoo-display-test.py:310`）。

## 補足（優先度順の対応提案）

- 1. `pixoo-display-test.py` のPixoo送信部に通信例外ハンドリングと再接続（指数バックオフでも可）を追加
- 2. 表示側から `STATE_FILE` への書き戻しをやめる（TTLは読み込み時フィルタのみにする）
- 3. Gitスキャンを別スレッド/別プロセス/キャッシュ化して描画ループから分離
- 4. `read_agent_state()` のJSONスキーマ防御（root型/agents要素型の検証）
- 5. tmux syncの識別子を `window_index` ベースへ統一（`id` と `first_seen` キー）
