# コード再レビュー（🔴修正後確認 / QA）

対象コミット: `eb2476d`  
対象ファイル: `pixoo-display-test.py`, `pixoo_tmux_sync.py`  
レビュー範囲: 前回レビュー `reviews/codex-qa-20260227.md` の **🔴致命的3件の再確認**

## スコア
**92/100**

- 総評: 前回の🔴致命的3件は、差分・現行コード上でいずれも修正を確認。特に `display` 側の共有JSON書き戻し削除は責務分離の観点で重要な改善です。なお、Pixoo初期化時の例外保護は未確認のため残留リスクとして🟡に記載します。

## 🔴 致命的

- **なし（前回指摘3件はいずれも修正確認）**

## 🟡 改善

- **Pixoo初期化時（`Pixoo(PIXOO_IP)`）の例外は依然として未保護**
  - `pixoo-display-test.py:518` の初期化は `try/except` 外です。
  - 今回の修正で **送信時** の例外耐性と再接続は追加されていますが（`pixoo-display-test.py:742`）、`Pixoo` コンストラクタが通信開始時に例外を投げる実装の場合は、起動時オフラインで落ちる可能性が残ります。
  - 備考: ライブラリ実装次第のため、ここは「要確認 / 保険として保護推奨」。

- **送信失敗時の5秒バックオフは妥当だが、その間は描画/状態更新が止まる**
  - `pixoo-display-test.py:747` の `time.sleep(5)` により、オフライン時のCPU暴走は防げます。
  - 一方で、この間は状態ファイル反映やアニメ更新も止まるため、運用上気になるなら送信経路だけの再試行制御に分離余地があります（改善提案レベル）。

## 🟢 良い点

- **1. Pixooオフライン即死対策（送信時）を確認**
  - `pixoo.draw_image()` / `pixoo.push()` が `try/except` で保護され、失敗時にログ出力・バックオフ・再接続試行が追加されています（`pixoo-display-test.py:742`）。
  - これにより、少なくとも描画ループ中の通信失敗でプロセスが即終了する問題は解消方向です。

- **2. display側の共有JSON書き戻し削除（read-only化）を確認**
  - TTL期限切れ検出時に `STATE_FILE` へ書き戻していた処理が削除され、コメントでも「sync daemon のみが writer」と明示されています（`pixoo-display-test.py:202`）。
  - `display` 側からの競合上書き・非原子的書き込みリスクの主要因が解消されています。

- **3. エラー状態フリッカー対策（`last_outputs` 更新スキップ）を確認**
  - `ERROR_PATTERN_RE` 検出時に `last_outputs[window_name] = captured` を行わない実装へ変更され、コメントでも意図が明確です（`pixoo_tmux_sync.py:120`）。
  - 前回指摘の `error -> active/waiting` の不自然な揺れを抑える修正として妥当です。

## 結論（再確認結果）

- 前回の🔴致命的3件は **修正済み** と判断します。
- 追加で気になるのは「Pixoo初期化時の例外保護」のみ（🟡）。コードの安全性をさらに上げるなら `pixoo = Pixoo(PIXOO_IP)` も再接続戦略に寄せるとより堅くなります。
