# コードレビュー — Pixoo Display Phase 1-4
**日時**: 2026-02-27
**レビュアー**: Claude Sonnet 4.6
**対象**: `pixoo_tmux_sync.py` / `pixoo-display-test.py`
**スコア**: 82/100

---

## サマリー

全体的に構造が整理されており、atomic write・TTL・ANSI除去など重要な安全策が実装されている。ただし、いくつかの論理バグとエッジケースが残存する。

---

## 🔴 Critical（致命的）

### C-1: `determine_status` でエラー状態が次ポーリングでリセットされる
**場所**: `pixoo_tmux_sync.py:120-124`

エラー検出後に `last_outputs[window_name] = captured` を更新してしまうため、次の 3 秒ポーリングでは出力が変化していない限り `captured \!= prev` が False になり、`WAITING_THRESHOLD_SEC` (30秒) を経過するまで `"active"` に戻る。つまり「エラー検出 (1回) → 次ポーリングで誤って active → 30秒後に waiting」という状態遷移になる。本来はエラー状態を保持し続けるか別フラグで管理すべき。

---

## 🟡 Major（改善推奨）

### M-1: `build_agents` の classified に PL も含まれる
**場所**: `pixoo_tmux_sync.py:281-283`

classified に PL も追加されており、Second Pass で selected_pl_idx が None の場合（PL 候補が 0 のとき）、条件 `w["window_index"] \!= None` が常に True になり全 PL が DEV に降格する。実際には pl_candidates が空でない場合は selected_pl_idx が必ず設定されるため問題は発生しないが、コードの意図が読みにくい。

### M-2: `read_agent_state` が STATE_FILE を直接上書き（非 atomic）
**場所**: `pixoo-display-test.py:207`

TTL 期限切れエージェントを除去する際、display 側が `STATE_FILE.write_text()` で直接上書きしている。sync 側は atomic (tempfile + os.replace) を使っているにもかかわらず、display 側では非 atomic。同時に sync デーモンが書き込んだ場合、ファイルが破損する可能性がある。

### M-3: `get_latest_git_commits` 内でのインポート
**場所**: `pixoo-display-test.py:299`

`subprocess` を関数内でインポートしている。トップレベルでインポートするよう統一すべき。

### M-4: `capture_pane` の alt-screen 判定が不完全
**場所**: `pixoo_tmux_sync.py:84-85`

vim/less が alt-screen を使っている場合、`tmux capture-pane` は alt-screen の内容（vim バッファなど）をキャプチャしてしまう場合がある。`#{pane_in_mode}` の事前チェックや `-eJ` オプションの使用が確実。

### M-5: `ANSI_ESCAPE_RE` に重複パターン
**場所**: `pixoo_tmux_sync.py:32-37`

1番目 `\x1b\[[0-9;]*[a-zA-Z]` と 3番目 `\x1b\[[\d;]*[@-~]` が大幅に重複している。動作は正しいが冗長でパフォーマンスを若干悪化させる。

### M-6: エラー状態が 1 ポーリングしか持続しない（C-1 の副次問題）
C-1 と同根。エラー検出後すぐに `last_outputs` が更新されるため、次のポーリングでは diff = unchanged → active 判定になる。

---

## 🟢 良い点

### G-1: write_state の atomic write 実装が堅牢
tempfile + os.replace パターンで競合リードを防止。BaseException キャッチで KeyboardInterrupt 時もクリーンアップされる。

### G-2: tkinter スタブが丁寧
headless 環境での動作を考慮した `_ensure_pixoo_import_works_without_tk` が環境依存を適切に吸収している。

### G-3: ScrollTextCache でパフォーマンス最適化
Pilmoji の描画をテキスト変更時のみ実行する設計が CPU 使用率の観点で正しい。

### G-4: window_index を diff キーに採用
同名ウィンドウの衝突を避けるための正しい判断。

### G-5: first_seen の整合的な管理
ウィンドウ名ベースで一貫しており、再起動後もタイマーが継続される。

### G-6: 全 subprocess 呼び出しに timeout 設定
tmux 無応答時の 5 秒タイムアウトでデーモンのハングを防止。

### G-7: TTL による stale エージェントの自動除去
AGENT_TTL_SEC (600秒) による安全網は sync デーモン停止時の表示残留を防ぐ。

---

## 修正提案

### C-1 の修正（優先度: 高）

エラー検出時に `last_outputs` を更新しないことで、次ポーリングでも diff=unchanged とならず、エラー状態を維持できる。

### M-2 の修正（優先度: 中）

display 側は STATE_FILE への書き込みを行わず、TTL 除去はメモリ上のみで実施。STATE_FILE への書き込みは sync デーモンに一任することで競合を解消。

---

## 統合性チェック

| 項目 | 状態 |
|------|------|
| sync → JSON フォーマット互換 | ✅ 互換キー全て存在 |
| display → JSON 読み取り | ✅ get/fallback で安全 |
| atomic write | ✅ sync 側のみ / ⚠️ display TTL 側は非 atomic |
| tmux 未起動時 | ✅ 空リスト書き出し |
| Pixoo オフライン時 | ✅ push() 例外は main ループで継続 |
| Phase 1-3 連携 | ✅ scroll_text / status キーが正しく伝播 |
| Phase 4 (カタカナアイコンバー) | ✅ ROLE_LABELS + ROLE_COLORS で実装済み |

---

## 総合評価

**82/100**

- 🔴 Critical: 1件（C-1: エラー状態の誤リセット）
- 🟡 Major: 6件（atomic書き込み・alt-screen・重複正規表現等）
- 🟢 Good: 7件

コア機能（tmux監視 → JSON書き出し → display描画）は動作可能。C-1 のエラー状態バグを修正すれば実運用レベルに到達する。
