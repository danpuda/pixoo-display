# Codex QA 🟡改善4件修正 レビュー（対象コミット: `2a2c15b`）

スコア: **91/100**

## 🔴致命的

- なし

## 🟡改善

1. `/tmp` 権限チェックは改善だが、symlink/TOCTOU 対策としては未完了
   - `pixoo_tmux_sync.py:161`-`170` の `CONFIG_FILE.exists()` → `os.stat(CONFIG_FILE)` → `CONFIG_FILE.read_text()` は別操作で、チェック後に差し替えられる余地があります（TOCTOU）。
   - さらに `os.stat()` は symlink を追跡するため、docstring の「symlink attacks を防ぐ」は言い過ぎです。少なくとも symlink 自体の拒否（`lstat` / `is_symlink`）か、`os.open(..., O_NOFOLLOW)` + `fstat` の一体化が必要です。
   - 現状でも「他人所有ファイルの読み込み回避」という改善にはなっていますが、セキュリティ主張は弱めるか実装を強化した方がよいです。

2. 4件の修正のうち 2件（Ctrl+C UX、`st_uid` チェック）には回帰テストが追加されていない
   - 今回追加された新規テスト2件は妥当ですが、`pixoo-display-test.py` の `KeyboardInterrupt` 挙動と `load_config()` の所有者不一致スキップは未テストです。
   - 既存テストは通過しており回帰は見えていませんが、この2点は将来の変更で戻りやすい箇所です。

## 🟢良い点

1. off-by-one 修正（`>` → `>=`）は正しく実装されている
   - `pixoo_tmux_sync.py:145` で境界値を含む判定になっており、仕様意図（閾値ちょうどで `waiting`）と一致しています。
   - `tests/test_tmux_sync.py:172` の新規テストで境界値が明示的に検証されており、回帰防止として有効です。

2. 同名 window 衝突対策（`window_index` ベース ID）は妥当
   - `pixoo_tmux_sync.py:325`-`346` で `first_seen` キーと `agent["id"]` を `window_index` 文字列に統一しており、同名 window の衝突を回避できています。
   - prune 処理も同じキー体系に揃っており、部分修正ではなく一貫している点が良いです。
   - `tests/test_tmux_sync.py:356` の新規テストで同名2 window の ID 一意性と `task` 維持を確認しており、観点が適切です。

3. Ctrl+C UX 改善は実運用で効く実装
   - `pixoo-display-test.py:519`-`530` で初期化リトライ中の `KeyboardInterrupt` を捕捉して即 return しており、終了時 UX が改善されています。
   - 最終失敗時に不要な `sleep(5)` をしない修正（`_attempt < 2`）も含まれており、待ち時間の無駄を減らせています。

4. 既存テストは壊れていない
   - `pytest -q` 実行結果: **52 passed**
   - 変更による既存テストの回帰は確認できませんでした。

## 新規テスト2件の妥当性評価（要点）

- `tests/test_tmux_sync.py:172` `test_same_output_becomes_waiting_at_exact_threshold`
  - 目的が明確で、今回の off-by-one 修正をピンポイントで守る良い境界値テスト。

- `tests/test_tmux_sync.py:356` `test_same_name_windows_get_unique_ids`
  - 再発しやすい実バグ（同名 window）を最小入力で再現し、`id` 一意性と `task` 互換性を同時に見ているため妥当。
